name: Terraform Apply

on:
  push:
    branches:
      - main
    paths:
      - 'requests/in-progress/**/*.tf'

permissions:
  id-token: write
  contents: write
  pull-requests: write

env:
  AWS_REGION: us-east-1

jobs:
  apply:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::414483036967:role/GitHubActionsExecutor
          aws-region: ${{ env.AWS_REGION }}

      - name: Find changed request directories
        id: changes
        run: |
          # Find all directories with .tf files that were changed in the last commit
          CHANGED_DIRS=$(git diff --name-only HEAD~1 HEAD | \
            grep -E '^requests/in-progress/.*/.*\.tf$' | \
            xargs -I {} dirname {} | \
            sort -u)

          if [ -z "$CHANGED_DIRS" ]; then
            echo "No Terraform changes found"
            echo "dirs=" >> $GITHUB_OUTPUT
          else
            echo "Found changed directories:"
            echo "$CHANGED_DIRS"
            DIRS_JSON=$(echo "$CHANGED_DIRS" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "dirs=$DIRS_JSON" >> $GITHUB_OUTPUT
          fi

      - name: Terraform Apply
        id: apply
        run: |
          RESULTS=""

          for dir in $(echo '${{ steps.changes.outputs.dirs }}' | jq -r '.[]'); do
            echo "Applying: $dir"
            cd "$dir"

            TICKET_ID=$(basename "$dir")

            echo "### Terraform Apply for $TICKET_ID" >> $GITHUB_STEP_SUMMARY

            terraform init -input=false

            if terraform apply -auto-approve -input=false; then
              echo "SUCCESS: $TICKET_ID"
              RESULTS="$RESULTS|$TICKET_ID:success"

              # Capture outputs
              terraform output -json > outputs.json

              # Update request metadata
              if [ -f request.json ]; then
                jq '.status = "deployed" | .deployed_at = now | .outputs = input' \
                  request.json outputs.json > request_updated.json
                mv request_updated.json request.json
              fi
            else
              echo "FAILED: $TICKET_ID"
              RESULTS="$RESULTS|$TICKET_ID:failed"

              if [ -f request.json ]; then
                jq '.status = "failed" | .failed_at = now' request.json > request_updated.json
                mv request_updated.json request.json
              fi
            fi

            cd - > /dev/null
          done

          echo "results=$RESULTS" >> $GITHUB_OUTPUT

      - name: Move completed requests
        run: |
          for dir in $(echo '${{ steps.changes.outputs.dirs }}' | jq -r '.[]'); do
            TICKET_ID=$(basename "$dir")

            if [ -f "$dir/request.json" ]; then
              STATUS=$(jq -r '.status' "$dir/request.json")

              case "$STATUS" in
                "deployed")
                  TARGET_DIR="requests/deployed/$TICKET_ID"
                  ;;
                "failed")
                  TARGET_DIR="requests/failed/$TICKET_ID"
                  ;;
                *)
                  continue
                  ;;
              esac

              echo "Moving $TICKET_ID to $TARGET_DIR"
              mkdir -p "$(dirname "$TARGET_DIR")"
              mv "$dir" "$TARGET_DIR"
            fi
          done

      - name: Commit status changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add requests/

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: Update request statuses after apply"
            git push
          fi

      - name: Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for result in $(echo "${{ steps.apply.outputs.results }}" | tr '|' '\n'); do
            if [ -n "$result" ]; then
              TICKET=$(echo "$result" | cut -d: -f1)
              STATUS=$(echo "$result" | cut -d: -f2)

              if [ "$STATUS" = "success" ]; then
                echo "- ✅ $TICKET: Deployed successfully" >> $GITHUB_STEP_SUMMARY
              else
                echo "- ❌ $TICKET: Deployment failed" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done
